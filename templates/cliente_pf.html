<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>ClientePF</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='cliente.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='chaticon.css') }}">
  </head>
  <body>
    <nav class="navbar navbar-light bg-light shadow">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Menu App</span>
        <h1 class="modal-title" id="username-header">Sejá Bem Vindo, {{username}}</h1>
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>

    <!-- Formulário de cadastro de usuário -->
    <form id="userForm" class="container mt-5">

      <!-- Campo para o nome completo -->
      <div class="mb-3">
          <!-- <label for="nomecompleto">Nome Completo:</label> -->
          <input type="text" id="nomecompleto" name="nomecompleto" class="form-control" placeholder="Nome Completo" required>
          <div class="invalid-feedback">Por favor, insira um nome válido (mínimo 5 caracteres).</div>
      </div>

      <div class="mb-3">
        <!-- <label for="cpf">CPF:</label> -->
        <!-- <input type="text" id="cpf" name="cpf" class="form-control" placeholder="CPF" required> -->
        <input type="text" id="cpf" name="cpf" class="form-control" placeholder="CPF" pattern="\d{11}" title="Digite um CPF válido com 11 dígitos" required>
        <!-- <input type="text" data-id="Cpf" disabled name="Cpf" id="Cpf" class="form-control" onblur="javascript: validarCPF(this.value);" > -->
        <div class="invalid-feedback">Preencha Seu CPF apenas com numeros(00000000000)</div>
      </div>
        
      <div class="mb-3">
        <!-- <label for="genero">Genero:</label> -->
        <select id="genero" name="genero" >
            <option value="" disabled selected>Selecione o Gênero</option>
            <option value="feminino">Feminino</option>
            <option value="masculino">Masculino</option>
            <option value="transgenero">Transgênero</option>
            <option value="naobinario">Não-binário</option>
            <option value="outros">Outros</option>
        </select>
      </div>

      <div class="mb-3">
        <!-- <label for="estadocivil">Estado Civil:</label> -->
        <select id="estadocivil" name="estadocivil" >
            <option value="" disabled selected>Selecione seu Estado Civil</option>
            <option value="solteiro">Solteiro</option>
            <option value="casado">Casado</option>
            <option value="separado">Separado</option>
            <option value="divorciado">Divorciado </option>
            <option value="viuvo">Viúvo</option>
            <option value="outros">Outros</option>
        </select>
      </div>

      <div class="mb-3">
        <!-- <label for="date">Data de Nascimento:</label> -->
        <input type="date" name="date" id="date" placeholder="Digite a data de nascimento">
      </div>

      <!-- Campo para o telefone celular -->
      <div class="mb-3">
          <!-- <label for="telefone">Telefone:</label>  -->
          <input type="text" id="telefone" name="telefone" class="form-control" placeholder="Telefone Celular" required>
          <div class="invalid-feedback">Por favor, insira um número de celular válido.</div>
      </div>

      <!-- Campo para o e-mail -->
      <div class="mb-3">
          <!-- <label for="email">E-mail:</label>  -->
          <input type="text" id="email" name="email" class="form-control" placeholder="E-mail" required>
          <div class="invalid-feedback">Por favor, insira um email válido (deve terminar com .com, .br, .org, etc.).</div>
      </div>

      <div class="mb-3">
        <!-- <label for="estado">Estado:</label>  -->
        <select name="estado" id="estado" >
            <option value="" disabled selected>Selecione o estado</option>
            <option value="AC">AC</option>
            <option value="AL">AL</option>
            <option value="AP">AP</option>
            <option value="AM">AM</option>
            <option value="BA">BA</option>
            <option value="CE">CE</option>
            <option value="DF">DF</option>
            <option value="ES">ES</option>
            <option value="GO">GO</option>
            <option value="MA">MA</option>
            <option value="MT">MT</option>
            <option value="MS">MS</option>
            <option value="MG">MG</option>
            <option value="PA">PA</option>
            <option value="PB">PB</option>
            <option value="PR">PR</option>
            <option value="PE">PE</option>
            <option value="PI">PI</option>
            <option value="RJ">RJ</option>
            <option value="RN">RN</option>
            <option value="RS">RS</option>
            <option value="RO">RO</option>
            <option value="RR">RR</option>
            <option value="SC">SC</option>
            <option value="SP">SP</option>
            <option value="SE">SE</option>
            <option value="TO">TO</option>
        </select>
      </div>

      <!-- <div class="mb-3">
        <label for="cidade">Cidade:</label>  -->
        <input type="text" id="cidade" name="cidade" class="form-control" placeholder="Cidade" required>
        <div class="invalid-feedback">Preencha com o Nome da Cidade onde Reside</div>
      </div>
    
      <div class="mb-3">
        <!-- <label for="bairro">Bairro:</label>  -->
        <input type="text" id="bairro" name="bairro" class="form-control" placeholder="Bairro" required>
        <div class="invalid-feedback">Preencha com o Nome do Bairro onde Reside </div>
      </div>

      <div class="mb-3">
        <!-- <label for="endereço">Endereço:</label>  -->
        <input type="text" id="endereço" name="endereço" class="form-control" placeholder="Endereço" required>
        <div class="invalid-feedback">Preencha com o Nome do endereço onde Reside</div>
      </div>

      <div class="mb-3">
        <!-- <label for="complemento">Complemento:</label>  -->
        <input type="text" id="complemento" name="complemento" class="form-control" placeholder="Complemento">
      </div>


      <!-- Botão de envio do formulário -->
      <button type="submit" class="btn btn-primary">Enviar</button>
      <!-- Div para exibir mensagens de sucesso ou erro -->
      <div id="message" class="message mt-3" style="display: none;"></div>
  </form>

  <!-- Modal de sucesso -->
  <!-- <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="successModalLabel">Sucesso</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  Cadastro realizado com sucesso!
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="confirmButton">OK</button>
              </div>
          </div>
      </div>
  </div> -->
  

    <!-- Ícone de chat -->
    <div class="chat-icon" id="chatIcon" onclick="toggleChat()">
      <i class="fas fa-comments"></i>
    </div>

    <div class="chat-window" id="chatWindow" style="display: none;">
      <div class="chat-header">
        Chat Bot <button type="button" class="close-btn" onclick="toggleChat()">X</button>
      </div>
      <div class="chat-body" id="chatBody">
        <p>Bem-vindo! Como posso ajudar?</p>
      </div>
      <div id="chatbox">
        <!-- Conteúdo do chatbox será adicionado aqui -->
      </div>
      <div class="chat-footer">
        <input type="text" id="chatInput" placeholder="Digite sua mensagem..." autofocus>
        <button type="button" onclick="sendMessageDirect()">Enviar</button>
      </div>
    </div>

  <!-- Conteúdo do menu -->
  <div class="modal true" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="exampleModalLabel">MENU</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group list-group-flush">
            <li><a href="/home" id="linkHome"><i class="fas fa-home"></i>Home Page</a></li>
            <li><a href="/dashboard"><i class="fa fa-chart-line" aria-hidden="true"></i>Dashboard</a></li>
            <!-- <li><a href="/faturamento"><i class="fa fa-chart-line" aria-hidden="true"></i>Faturamento</a></li> -->
            <li><a href="/services"><i class="fa fa-cogs"></i>Services</a></li>
            <li><a href="/minha_conta"><i class="fa fa-user-circle"></i> Minha Conta</a></li>
            <li><a href="/clientepf"><i class="fa fa-user-plus" aria-hidden="true"></i>Cadastrar Cliente PF</a></li>
            <li><a href="/enviar_documentos"><i class="fa fa-paper-plane" aria-hidden="true"></i>Enviar Documentos</a></li>
            <li><a href="/Veiculo"><i class="fa fa-question-circle"></i> Veículo</a></li>
            <li><a href="/feedback"><i class="fa fa-comment"></i> Feedback</a></li>
            <li><a href="#" id="logout-link"><i class="fa fa-sign-out-alt" aria-hidden="true"></i> Logout</a></li>
          </ul>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Sessão Expirada (invisível por padrão) -->
  <div id="expiredSessionModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background-color:#f8d7da; color:#721c24; border:1px solid #f5c6cb; padding:20px; border-radius:8px; z-index: 1000;">
    <h3>Sessão Expirada</h3>
    <p>Sua sessão expirou. Por favor, faça login novamente para continuar.</p>
    <button id="loginButton" style="background-color:#f5c6cb; border:none; padding:10px; color:#721c24; cursor:pointer;">Ir para a Página de Login</button>
  </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="./static/rotacao_paginas.js"></script>
    <script src="{{ url_for('static', filename='logout.js') }}"></script>
    <script src="{{ url_for('static', filename='rot_pag_protegida.js') }}"></script> 
    <script src="{{ url_for('static', filename='lidar_token_exp.js') }}"></script> 
    
    <script>

  

  // Função para validar o formulário e capturar dados
  document.getElementById('userForm').addEventListener('submit', function(event) {
    // Previne o envio padrão do formulário
    event.preventDefault();

    // Inicializa a variável formIsValid como true
    let formIsValid = true;

    // Captura os valores dos campos
    const nome = document.getElementById('nomecompleto').value.trim();
    const cpf = document.getElementById('cpf').value.trim();
    const genero = document.getElementById('genero').value.trim();
    const estadocivil = document.getElementById('estadocivil').value.trim();
    const dataNascimento = document.getElementById('date').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const email = document.getElementById('email').value.trim();
    const estado = document.getElementById('estado').value.trim();
    const cidade = document.getElementById('cidade').value.trim();
    const bairro = document.getElementById('bairro').value.trim();
    const endereco = document.getElementById('endereço').value.trim();
    const complemento = document.getElementById('complemento').value.trim(); // Não obrigatório

    // Adicionando logs no console para verificar os dados capturados
    console.log("Dados capturados:", {
      nome, cpf, genero, estadocivil, dataNascimento, telefone, email,
      estado, cidade, bairro, endereco, complemento
    });

    

    // Validação do nome completo (mínimo 2 palavras)
    if (!/^[a-zA-Z]{2,}\s[a-zA-Z]{2,}(\s[a-zA-Z]{2,})*$/.test(nome)) {
      $('#nomecompleto').addClass('is-invalid');
      $('#nomecompleto').next('.invalid-feedback').text('Por favor, insira um nome completo válido com pelo menos duas palavras (ex: Ana Silva).');
      formIsValid = false;
    } else {
      $('#nomecompleto').removeClass('is-invalid');
      $('#nomecompleto').next('.invalid-feedback').text('');
    }

    // Validação do email (deve terminar com .com, .br, .org, etc.)
    if (!/^[^@]+@[^@]+\.[a-zA-Z]{2,}$/.test(email)) {
      $('#email').addClass('is-invalid');
      $('#email').next('.invalid-feedback').text('Por favor, insira um email válido.');
      formIsValid = false;
    } else {
      $('#email').removeClass('is-invalid');
      $('#email').next('.invalid-feedback').text('');
    }

    // Validação do celular
    if (!/^\d{11}$/.test(telefone)) {
      $('#telefone').addClass('is-invalid');
      $('#telefone').next('.invalid-feedback').text('Por favor, insira um número de celular válido com 11 dígitos.');
      formIsValid = false;
    } else {
      $('#telefone').removeClass('is-invalid');
      $('#telefone').next('.invalid-feedback').text('');
    }

 

    // Validação da cidade (deve aceitar mais de uma palavra e caracteres especiais)
    if (!/^[a-zA-ZÀ-ÿ\s.'-]{2,}$/.test(cidade)) {
      $('#cidade').addClass('is-invalid');
      $('#cidade').next('.invalid-feedback').text('Por favor, insira um nome de cidade válido.');
      formIsValid = false;
    } else {
      $('#cidade').removeClass('is-invalid');
      $('#cidade').next('.invalid-feedback').text('');
    }

    // Validação do bairro (deve aceitar mais de uma palavra e caracteres especiais)
    if (!/^[a-zA-ZÀ-ÿ\s.'-]{2,}$/.test(bairro)) {
      $('#bairro').addClass('is-invalid');
      $('#bairro').next('.invalid-feedback').text('Por favor, insira um nome de bairro válido.');
      formIsValid = false;
    } else {
      $('#bairro').removeClass('is-invalid');
      $('#bairro').next('.invalid-feedback').text('');
    }

    // Validação do endereço (deve aceitar números, mais de uma palavra e caracteres especiais)
    if (!/^[a-zA-ZÀ-ÿ0-9\s.,'°ªº#-/]{2,}$/.test(endereco)) {
      $('#endereço').addClass('is-invalid');
      $('#endereço').next('.invalid-feedback').text('Por favor, insira um endereço válido.');
      formIsValid = false;
    } else {
      $('#endereço').removeClass('is-invalid');
      $('#endereço').next('.invalid-feedback').text('');
    }


    // Validação da data de nascimento (campo obrigatório)
    if (!/^\d{4}-\d{2}-\d{2}$/.test(dataNascimento)) {
      $('#date').addClass('is-invalid');
      $('#date').next('.invalid-feedback').text('Por favor, insira uma data de nascimento válida.');
      formIsValid = false;
    } else {
      $('#date').removeClass('is-invalid');
      $('#date').next('.invalid-feedback').text('');
    }

    // Validação do estado civil (obrigatório)
    if (estadocivil === "") {
      $('#estadocivil').addClass('is-invalid');
      $('#estadocivil').next('.invalid-feedback').text('Por favor, selecione o estado civil.');
      formIsValid = false;
    } else {
      $('#estadocivil').removeClass('is-invalid');
      $('#estadocivil').next('.invalid-feedback').text('');
    }

    // Validação do estado (obrigatório)
    if (estado === "") {
      $('#estado').addClass('is-invalid');
      $('#estado').next('.invalid-feedback').text('Por favor, selecione o estado.');
      formIsValid = false;
    } else {
      $('#estado').removeClass('is-invalid');
      $('#estado').next('.invalid-feedback').text('');
    }

    // Validação do gênero (obrigatório)
    if (genero === "") {
      $('#genero').addClass('is-invalid');
      $('#genero').next('.invalid-feedback').text('Por favor, selecione o gênero.');
      formIsValid = false;
    } else {
      $('#genero').removeClass('is-invalid');
      $('#genero').next('.invalid-feedback').text('');
    }

     // Se o formulário for válido, realiza a requisição
     if (formIsValid) {
        alert("O formulário é válido, enviando requisição...");

        // Função para pegar o valor de um cookie pelo nome
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Captura o CSRF token do cookie
        const csrfToken = getCookie('csrf_access_token');

        // Enviar a requisição com o token CSRF
        fetch('http://127.0.0.1:5000/cadastro_clientepf', {
            method: 'POST',
            credentials: 'include', // Inclui cookies na requisição
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken // Inclui o CSRF token no cabeçalho
            },
            body: JSON.stringify({
                nome, cpf, genero, estadocivil, dataNascimento, telefone, email, estado, cidade, bairro, endereco, complemento
            })
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            if (status >= 200 && status < 300) {
                // alert("Cadastro realizado com sucesso!");
                // const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                showSuccessModal();
                document.getElementById('userForm').reset();
                // console.log('Status:', status);
                console.log('Cadastro realizado com sucesso:', body);
            } else {
                alert("Erro na API: " + body.message);
                const messageDiv = document.getElementById('message');
                messageDiv.style.display = 'block';
                messageDiv.className = 'message error';
                messageDiv.textContent = `${body.stage}: ${body.message}`;
            }
        })
        .catch(error => {
            alert("Erro na conexão com a API: " + error);
            console.error('Erro API:', error);
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'block';
            messageDiv.className = 'message error';
            messageDiv.textContent = `Erro API: Falha ao conectar à API ou rota não encontrada (${error})`;
        });
    } else {
        alert('Há erros no formulário. Corrija-os antes de continuar.');
    }
});

$(document).ready(function(){
  $('#telefone').mask('00000000000'); // Máscara para 11 dígitos consecutivos
  $('#cpf').mask('00000000000');
});






        
    </script>
  </body>
</html>