<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Veiculo</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='veiculo.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='chaticon.css') }}">
  </head>
  <body>
    <nav class="navbar navbar-light bg-light shadow">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Menu App</span>
        <h1 class="modal-title" id="username-header">Sejá Bem Vindo, {{username}}</h1>
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>

    <!-- Formulário de cadastro de usuário -->
    <form id="userForm" class="container mt-5">
        
      <div class="mb-3"></div>
        <label for="renavam">renavam:</label>
        <input type="text" id="renavam" name="renavam" class="form-control" placeholder="renavam" required>
        <div class="invalid-feedback">Preencha com o numero do renavam</div>
      </div>
    
      <div class="mb-3">
        <label for="numero_chassi">Número do Chassi:</label>
        <input type="text" id="numero_chassi" name="numero_chassi" class="form-control" placeholder="Numero Chassi" required>
        <div class="invalid-feedback">Preencha com o numero do Chassi</div>
      </div>

      <div class="mb-3">
        <label for="date_ano_fabricacao">Ano de fabricação:</label>
        <input type="date" name="date_ano_fabricacao" id="date_ano_fabricacao" placeholder="Ano de fabricação">
      </div>

      <div class="mb-3"></div>
      <label for="date_ano_modelo">Ano/Modelo:</label>
        <input type="date" name="date_ano_modelo" id="date_ano_modelo" placeholder="Ano/Modelo">
      </div>      

      <div class="mb-3">
        <label for="marca">Modelo:</label>
        <input type="text" id="modelo" name="modelo" class="form-control" placeholder="Modelo" required>
        <div class="invalid-feedback">Preencha com o Modelo</div>
      </div>
      
      </div>
        <label for="cor">Cor:</label>
        <input type="text" id="cor" name="cor" class="form-control" placeholder="Cor" required>
        <div class="invalid-feedback">Preencha com a Cor</div>
      </div>

    </div>
      <label for="placa">Placa:</label>
      <input type="text" id="placa" name="placa" class="form-control" placeholder="Placa" required>
      <div class="invalid-feedback">Preencha com a Placa</div>
    </div>

    </div>
      <label for="preco_aquisicao">Preço de Aquisição:</label>
      <input type="text" id="preco_aquisicao" name="preco_aquisicao" class="form-control" placeholder="Preço de aquisição" required>
      <div class="invalid-feedback">Preencha com o valor da aquisição do veiculo</div>
    </div>

    <div class="mb-3"></div>
      <label for="laudo_cautelar">Laudo Cautelar:</label>
      <select id="laudo_cautelar" name="laudo_cautelar">
        <option value="" disabled selected>Laudo Cautelar:</option>
        <option value="aprovado"> Aprovado </option>
        <option value="aprovado_com_apontamentos">Aprovado com Apontamentos</option>
        <option value="laudo_reprovado">Laudo Reprovado</option>
      </select>
    </div>

    <div class="mb-3"></div>
      <label for="procedencia">Procedência:</label>
      <select id="procedencia" name="procedencia">
        <option value="" disabled selected>Selecione a Procedência:</option>
        <option value="aquisicao0km">0 KM</option>
        <option value="troca">Troca</option>
        <option value="consignacao">Consignação</option>
        <option value="leilao">Leilão</option>
        <option value="recuperacao">Recuperação </option>
        <option value="outras">Outras</option>
      </select>
    </div>
     
    <div class="mb-3">
      <label for="categoria">Categoria do Veiculo:</label>
      <select id="categoria" name="categoria">
        <option value="" disabled selected>Selecione a Categoria do Veiculo</option>
        <option value="passageiros">Passeio</option>
        <option value="carga">Carga</option>
        <option value="misto">Misto</option>
        <option value="competicao">Competição</option>
        <option value="tracao">Tração</option>
        <option value="especial ">Especial </option>
        <option value="colecao">Coleção</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="marca_carro">Marca do Veiculo:</label>
      <select id="marca_carro" name="marca_carro">
        <option value="" disabled selected>Selecione a Marca do Veiculo</option>
        <option value="fiat">Fiat</option>
        <option value="ford">Ford</option>
        <option value="chevrolet">Chevrolet</option>
        <option value="volkswagen">Volkswagen</option>
        <option value="renault">Renault</option>
        <option value="toyota">Toyota</option>
        <option value="honda">Honda</option>
        <option value="nissan">Nissan</option>
        <option value="hyundai">Hyundai</option>
        <option value="peugeot">Peugeot</option>
        <option value="bmw">BMW</option>
        <option value="mercedes">Mercedes-Benz</option>
        <option value="audi">Audi</option>
        <option value="lexus">Lexus</option>
        <option value="jaguar">Jaguar</option>
        <option value="porsche">Porsche</option>
        <option value="maserati">Maserati</option>
        <option value="land_rover">Land Rover</option>
        <option value="ferrari">Ferrari</option>
        <option value="lamborghini">Lamborghini</option>
      </select>
    </div>

    <div class="mb-3"></div>
    <label for="estado">Estado:</label>
      <select name="estado" id="estado" >
          <option value="" disabled selected>Selecione o estado</option>
          <option value="AC">AC</option>
          <option value="AL">AL</option>
          <option value="AP">AP</option>
          <option value="AM">AM</option>
          <option value="BA">BA</option>
          <option value="CE">CE</option>
          <option value="DF">DF</option>
          <option value="ES">ES</option>
          <option value="GO">GO</option>
          <option value="MA">MA</option>
          <option value="MT">MT</option>
          <option value="MS">MS</option>
          <option value="MG">MG</option>
          <option value="PA">PA</option>
          <option value="PB">PB</option>
          <option value="PR">PR</option>
          <option value="PE">PE</option>
          <option value="PI">PI</option>
          <option value="RJ">RJ</option>
          <option value="RN">RN</option>
          <option value="RS">RS</option>
          <option value="RO">RO</option>
          <option value="RR">RR</option>
          <option value="SC">SC</option>
          <option value="SP">SP</option>
          <option value="SE">SE</option>
          <option value="TO">TO</option>
      </select>
    </div>

    <div class="mb-3"></div>
    <label for="disponibilidade">Disponibilidade:</label>
    <select id="disponibilidade" name="disponibilidade">
      <option value="" disabled selected>Selecione a Disponibilidade:</option>
      <option value="disponível">disponível</option>
      <option value="vendido">vendido</option>
    </select>
  </div>
      


      <!-- Botão de envio do formulário -->
      <button type="submit" class="btn btn-primary">Enviar</button>
      <!-- Div para exibir mensagens de sucesso ou erro -->
      <div id="message" class="message mt-3" style="display: none;"></div>
  </form>

  <!-- Modal de sucesso -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="successModalLabel">Sucesso</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  Cadastro realizado com sucesso!
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="confirmButton">OK</button>
              </div>
          </div>
      </div>
  </div>

    
      <!-- Ícone de chat -->
      <div class="chat-icon" id="chatIcon" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
      </div>
  
      <div class="chat-window" id="chatWindow" style="display: none;">
        <div class="chat-header">
          Chat Bot <button type="button" class="close-btn" onclick="toggleChat()">X</button>
        </div>
        <div class="chat-body" id="chatBody">
          <p>Bem-vindo! Como posso ajudar?</p>
        </div>
        <div id="chatbox">
          <!-- Conteúdo do chatbox será adicionado aqui -->
        </div>
        <div class="chat-footer">
          <input type="text" id="chatInput" placeholder="Digite sua mensagem..." autofocus>
          <button type="button" onclick="sendMessageDirect()">Enviar</button>
        </div>
      </div>

    <!-- Conteúdo do menu -->
    <div class="modal true" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="exampleModalLabel">MENU</h3>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group list-group-flush">
              <li><a href="/home"><i class="fas fa-home"></i>Home Page</a></li>
              <li><a href="/dashboard"><i class="fa fa-chart-line" aria-hidden="true"></i>Dashboard</a></li>
              <!-- <li><a href="/faturamento"><i class="fa fa-chart-line" aria-hidden="true"></i>Faturamento</a></li> -->
              <li><a href="/services"><i class="fa fa-cogs"></i>Services</a></li>
              <li><a href="/minha_conta"><i class="fa fa-user-circle"></i> Minha Conta</a></li>
              <li><a href="/clientepf"><i class="fa fa-user-plus" aria-hidden="true"></i>Cadastrar Cliente PF</a></li>
              <li><a href="/enviar_documentos"><i class="fa fa-paper-plane" aria-hidden="true"></i>Enviar Documentos</a></li>
              <li><a href="/Veiculo"><i class="fa fa-question-circle"></i> Veículo</a></li>
              <li><a href="/feedback"><i class="fa fa-comment"></i> Feedback</a></li>
              <li><a href="#" id="logout-link"><i class="fa fa-sign-out-alt" aria-hidden="true"></i> Logout</a></li>
            </ul>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Sessão Expirada (invisível por padrão) -->
<div id="expiredSessionModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background-color:#f8d7da; color:#721c24; border:1px solid #f5c6cb; padding:20px; border-radius:8px; z-index: 1000;">
  <h3>Sessão Expirada</h3>
  <p>Sua sessão expirou. Por favor, faça login novamente para continuar.</p>
  <button id="loginButton" style="background-color:#f5c6cb; border:none; padding:10px; color:#721c24; cursor:pointer;">Ir para a Página de Login</button>
</div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="./static/rotacao_paginas.js"></script>
    <script src="{{ url_for('static', filename='logout.js') }}"></script>
    <script src="{{ url_for('static', filename='rot_pag_protegida.js') }}"></script>
    <script src="{{ url_for('static', filename='lidar_token_exp.js') }}"></script> 
    <script>
      // Função para validar o formulário e capturar dados
    document.getElementById('userForm').addEventListener('submit', function(event) {
    // Previne o envio padrão do formulário
      event.preventDefault();

    // Inicializa a variável formIsValid como true
    let formIsValid = true;

    // Captura os valores dos campos
    const categoria = document.getElementById('categoria').value.trim();
    const marca = document.getElementById('marca_carro').value.trim();
    const estado = document.getElementById('estado').value.trim();
    const anoFabricacao = document.getElementById('date_ano_fabricacao').value.trim();
    const ano_modelo = document.getElementById('date_ano_modelo').value.trim();    
    const renavam = document.getElementById('renavam').value.trim();
    const numeroChassi = document.getElementById('numero_chassi').value.trim();
    const modelo = document.getElementById('modelo').value.trim();
    const cor = document.getElementById('cor').value.trim();
    const placa = document.getElementById('placa').value.trim();
    const precoAquisicao = document.getElementById('preco_aquisicao').value.trim();
    const laudoCautelar = document.getElementById('laudo_cautelar').value.trim();
    const procedencia = document.getElementById('procedencia').value.trim();
    const disponibilidade = document.getElementById('disponibilidade').value.trim();


    // Adicionando logs no console para verificar os dados capturados
    console.log("Dados capturados:", {
        categoria, marca, estado, anoFabricacao, renavam, numeroChassi, modelo, cor,
        placa, precoAquisicao, laudoCautelar, procedencia, ano_modelo, disponibilidade
    });

    // Verificar se os campos são válidos (adicionar as validações necessárias)
    // Exemplo de validação simples: verificar se o campo não está vazio
    if (!categoria || !marca || !estado || !anoFabricacao || !renavam || 
        !numeroChassi || !modelo || !cor || !placa || !precoAquisicao || 
        !laudoCautelar || !procedencia || !ano_modelo || !disponibilidade) {
        alert('Preencha todos os campos corretamente.');
        formIsValid = false;
    }

    // Se o formulário for válido, realiza a requisição
    if (formIsValid) {
        alert("O formulário é válido, enviando requisição...");

        // Função para pegar o valor de um cookie pelo nome
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Captura o CSRF token do cookie (se necessário)
        const csrfToken = getCookie('csrf_access_token');

        // Enviar a requisição com o token CSRF (se aplicável)
        fetch('http://127.0.0.1:5000/cadastro_veiculos', {
            method: 'POST',
            credentials: 'include', // Inclui cookies na requisição
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken // Inclui o CSRF token no cabeçalho (se necessário)
            },
            body: JSON.stringify({
              categoria, marca, estado, anoFabricacao, renavam, numeroChassi, modelo, cor,
              placa, precoAquisicao, laudoCautelar, procedencia, ano_modelo, disponibilidade
            })
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            if (status >= 200 && status < 300) {
                showSuccessModal();  // Chama a função que exibe o modal de sucesso
                document.getElementById('userForm').reset();  // Reseta o formulário após o cadastro bem-sucedido
                console.log('Status:', status);
                console.log('Resposta da API:', body);
            } else {
                alert("Erro na API: " + body.message);
                const messageDiv = document.getElementById('message');
                messageDiv.style.display = 'block';
                messageDiv.className = 'message error';
                messageDiv.textContent = `${body.stage}: ${body.message}`;
            }
        })
        .catch(error => {
            alert("Erro na conexão com a API: " + error);
            console.error('Erro API:', error);
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'block';
            messageDiv.className = 'message error';
            messageDiv.textContent = `Erro API: Falha ao conectar à API ou rota não encontrada (${error})`;
        });
    } else {
        alert('Há erros no formulário. Corrija-os antes de continuar.');
    }
});

// Função para exibir o modal de sucesso e adicionar comportamento ao botão de confirmação
function showSuccessModal() {
    const successModalElement = document.getElementById('successModal');
    const successModal = new bootstrap.Modal(successModalElement);  // Inicializa o modal usando Bootstrap

    // Exibe o modal
    successModal.show();

    // Adiciona um evento ao botão "OK" do modal para realizar alguma ação específica
    document.getElementById('confirmButton').addEventListener('click', function () {
        // Aqui você pode definir qualquer ação adicional, como redirecionar para outra página, etc.
        successModal.hide();  // Esconde o modal após clicar no botão OK
    });
}


    </script>
  </body>
</html>
